---
title: "CRC_proteomics"
author: "Ehsan Zangene"
date: "2025-06-05"
output: html_document
---

```{r , include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(QFeatures)
library(SummarizedExperiment)
library(tidyverse)
library(msqrob2)
library(clusterProfiler)
library(org.Hs.eg.db)
library(EnhancedVolcano)
library(ggfortify)
library(pheatmap)
library(DT)
library(UpSetR)
library(pheatmap)
library(stringr)

load("../CRC_ProteoResistance_data/CRC_ProteoResistance_workspace.RData")
prot <- getWithColData(qf, "norm_proteins")
```

```{r , echo=FALSE}
cell_lines <- c("HCT116", "SW620")
de_results <- list()
deg_filtered <- list()

for (cl in cell_lines) {
  idx <- colData(prot)$cell_line == cl
  se_sub <- prot[, idx]
  se_sub$group <- droplevels(factor(se_sub$group))
  
  treatments <- unique(se_sub$treatment)
  treatments <- treatments[treatments != "Parental"]
  
  for (tr in treatments) {
    comp_name <- paste0(cl, "_", tr, "_vs_Parental")
    selected <- se_sub[, se_sub$treatment %in% c("Parental", tr)]
    selected$treatment <- droplevels(factor(selected$treatment))
    
    design <- model.matrix(~ 0 + selected$treatment)
    colnames(design) <- levels(selected$treatment)
    fit <- limma::lmFit(assay(selected), design)
    contrast_str <- paste0(tr, " - Parental")
    contrast_matrix <- limma::makeContrasts(contrasts = contrast_str, levels = design)
    fit2 <- limma::contrasts.fit(fit, contrast_matrix)
    fit2 <- limma::eBayes(fit2)
    
    top_res <- limma::topTable(fit2, coef = 1, number = Inf) %>%
      rownames_to_column("protein_id") %>%
      mutate(comparison = comp_name)
    
    degs <- top_res %>%
      filter(adj.P.Val < 0.0005, abs(logFC) > 2, AveExpr > 2)
    
    de_results[[comp_name]] <- top_res
    deg_filtered[[comp_name]] <- degs
  }
}

deg_counts <- sapply(deg_filtered, nrow)
deg_summary <- data.frame(Comparison = names(deg_counts), DEG_Count = deg_counts)
knitr::kable(deg_summary, caption = "Number of DEGs per Comparison")

```

```{r, echo=FALSE}
for (comp in names(deg_filtered)) {
  df <- de_results[[comp]]
  df$Significant <- with(df, ifelse(adj.P.Val < 0.0005 & abs(logFC) > 2 & AveExpr > 2, "Yes", "No"))
  
  p <- ggplot(df, aes(x = logFC, y = -log10(adj.P.Val), color = Significant)) +
    geom_point(alpha = 0.6) +
    geom_vline(xintercept = c(-2, 2), linetype = "dashed", color = "blue") +
    geom_hline(yintercept = -log10(0.0005), linetype = "dashed", color = "red") +
    scale_color_manual(values = c("grey60", "firebrick")) +
    labs(title = paste("Volcano Plot:", comp), x = "log2 Fold Change", y = "-log10 Adjusted P-value") +
    theme_minimal()
  print(p)
}
```

```{r, echo=FALSE}
library(pheatmap)
library(stringr)
library(dplyr)

for (comp in names(deg_filtered)) {
  message("Generating heatmap for: ", comp)
  
  # Extract parts from contrast name
  parts <- str_split(comp, "_")[[1]]
  cell_line <- parts[1]
  treatment <- paste(parts[2:(length(parts) - 2)], collapse = "_")
  
  # Get top 30 DEGs
  top30_df <- deg_filtered[[comp]] %>%
    arrange(adj.P.Val) %>%
    slice(1:30)
  top30_ids <- top30_df$protein_id
  
  # Clean gene symbols (e.g., sp|Q9XYZ|GENE_HUMAN → GENE)
  clean_symbols <- str_extract(top30_ids, "(?<=\\|)[^|]+(?=\\|[^|]+$)") %>%
    str_remove("_HUMAN$")
  
  # Subset relevant samples
  cd <- colData(qf[["norm_proteins"]])
  sample_idx <- cd$cell_line == cell_line & cd$treatment %in% c("Parental", treatment)
  mat <- assay(qf[["norm_proteins"]])[top30_ids, sample_idx, drop = FALSE]
  mat <- mat[apply(mat, 1, function(x) all(is.finite(x))), , drop = FALSE]
  
  if (nrow(mat) < 2 || ncol(mat) < 2) {
    message("⚠️ Skipping: not enough clean data for ", comp)
    next
  }
  
  # Rename rows with gene symbols
  rownames(mat) <- clean_symbols[match(rownames(mat), top30_ids)]
  
  # Clean column annotations
  ann <- as.data.frame(cd[sample_idx, c("cell_line", "treatment")])
  # ann$cell_line <- gsub("HCT116", "HCT", ann$cell_line)
  # ann$cell_line <- gsub("SW620", "SW", ann$cell_line)
  
  # Plot heatmap
  pheatmap(mat,
           scale = "row",
           annotation_col = ann,
           main = paste("Top 30 DEGs -", gsub("HCT116", "HCT", gsub("SW620", "SW", comp))),
           fontsize_row = 7,
           angle_col = 45)
}


```

```{r, echo=FALSE}
for (comp in names(deg_filtered)) {
  dat <- deg_filtered[[comp]] %>% arrange(adj.P.Val) %>% head(20)
  DT::datatable(
    dat,
    caption = htmltools::tags$caption(style = 'caption-side: top; text-align: left;', 
                                      paste("Top 20 DEGs for", comp)),
    options = list(pageLength = 10, scrollX = TRUE),
    rownames = FALSE
  ) %>% print()
}

```
